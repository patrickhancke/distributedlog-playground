# Apache Distributed Log playground

## Sample project to reproduce https://github.com/apache/bookkeeper/pull/1973

Preparation:
1. check the _org.apache.distributedlog.distributedlog-core_ version in the _pom.xml_ file
2. make sure you can connect to a Zookeeper / Bookkeeper cluster with an already created namespace
3. verify and configure if necessary the connection settings in the _Settings_ class

Configuration:
1. _SingleWriter_ configured with
> LogSegmentRollingIntervalMinutes=1

Steps to reproduce:
1. start _SingleWriter_ as Java application.
It will connect to DLog cluster and write a fixed number of entries, pausing between each write.
As expected the _SimpleLedgerAllocator_ kicks in every minute to handle the rollover.
Let it finish.
2. once the writer has finished, start _TailingReader_.
It will start reading the entries written on the log and will then block until new entries are available.
Let it run.
3. start _SingleWriter_ again
4. monitor the _TailingReader_, it will read a some freshly written entries but as soon as the segment rollover occurred, an exception is thrown:
> 09:40:23.985 [main-EventThread] INFO  o.a.d.ReadAheadEntryReader - segments is updated with [[LogSegmentId:115, firstTxId:0, lastTxId:10, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636291922, recordCount:11, regionId:0, status:0, logSegmentSequenceNumber:1, lastEntryId:20, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=1, entryId=0, slotId=0}, startSequenceId:0], [LogSegmentId:116, firstTxId:10, lastTxId:22, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636352198, recordCount:12, regionId:0, status:0, logSegmentSequenceNumber:2, lastEntryId:23, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=2, entryId=0, slotId=0}, startSequenceId:11], [LogSegmentId:117, firstTxId:22, lastTxId:34, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636412381, recordCount:12, regionId:0, status:0, logSegmentSequenceNumber:3, lastEntryId:23, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=3, entryId=0, slotId=0}, startSequenceId:23], [LogSegmentId:118, firstTxId:34, lastTxId:46, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636472579, recordCount:12, regionId:0, status:0, logSegmentSequenceNumber:4, lastEntryId:23, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=4, entryId=0, slotId=0}, startSequenceId:35], [LogSegmentId:119, firstTxId:46, lastTxId:58, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636532804, recordCount:12, regionId:0, status:0, logSegmentSequenceNumber:5, lastEntryId:23, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=5, entryId=0, slotId=0}, startSequenceId:47], [LogSegmentId:120, firstTxId:58, lastTxId:70, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636592955, recordCount:12, regionId:0, status:0, logSegmentSequenceNumber:6, lastEntryId:23, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=6, entryId=0, slotId=0}, startSequenceId:59], [LogSegmentId:121, firstTxId:70, lastTxId:82, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636653123, recordCount:12, regionId:0, status:0, logSegmentSequenceNumber:7, lastEntryId:23, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=7, entryId=0, slotId=0}, startSequenceId:71], [LogSegmentId:122, firstTxId:82, lastTxId:94, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636713228, recordCount:12, regionId:0, status:0, logSegmentSequenceNumber:8, lastEntryId:23, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=8, entryId=0, slotId=0}, startSequenceId:83], [LogSegmentId:123, firstTxId:94, lastTxId:100, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636748278, recordCount:6, regionId:0, status:0, logSegmentSequenceNumber:9, lastEntryId:11, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=9, entryId=0, slotId=0}, startSequenceId:95], [LogSegmentId:125, firstTxId:100, lastTxId:107, version:VERSION_V5_SEQUENCE_ID, completionTime:1552637973443, recordCount:8, regionId:0, status:0, logSegmentSequenceNumber:10, lastEntryId:15, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=10, entryId=0, slotId=0}, startSequenceId:101], [LogSegmentId:127, firstTxId:107, lastTxId:109, version:VERSION_V5_SEQUENCE_ID, completionTime:1552638498401, recordCount:3, regionId:0, status:0, logSegmentSequenceNumber:11, lastEntryId:5, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=11, entryId=0, slotId=0}, startSequenceId:109], [LogSegmentId:129, firstTxId:109, lastTxId:121, version:VERSION_V5_SEQUENCE_ID, completionTime:1552638558701, recordCount:13, regionId:0, status:0, logSegmentSequenceNumber:12, lastEntryId:24, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=12, entryId=0, slotId=0}, startSequenceId:112], [LogSegmentId:130, firstTxId:121, lastTxId:126, version:VERSION_V5_SEQUENCE_ID, completionTime:1552638682182, recordCount:5, regionId:0, status:0, logSegmentSequenceNumber:13, lastEntryId:10, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=13, entryId=0, slotId=0}, startSequenceId:125], [LogSegmentId:132, firstTxId:126, lastTxId:126, version:VERSION_V5_SEQUENCE_ID, completionTime:1552638726059, recordCount:1, regionId:0, status:0, logSegmentSequenceNumber:14, lastEntryId:1, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=14, entryId=0, slotId=0}, startSequenceId:130], [LogSegmentId:134, firstTxId:126, lastTxId:127, version:VERSION_V5_SEQUENCE_ID, completionTime:1552639163714, recordCount:2, regionId:0, status:0, logSegmentSequenceNumber:15, lastEntryId:3, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=15, entryId=0, slotId=0}, startSequenceId:131], [LogSegmentId:136, firstTxId:127, lastTxId:139, version:VERSION_V5_SEQUENCE_ID, completionTime:1552639223980, recordCount:13, regionId:0, status:0, logSegmentSequenceNumber:16, lastEntryId:24, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=16, entryId=0, slotId=0}, startSequenceId:133], [LogSegmentId:137, firstTxId:139, lastTxId:-999, version:VERSION_V5_SEQUENCE_ID, completionTime:0, recordCount:0, regionId:0, status:0, logSegmentSequenceNumber:17, lastEntryId:-1, lastSlotId:-1, inprogress:true, minActiveDLSN:DLSN{logSegmentSequenceNo=17, entryId=0, slotId=0}, startSequenceId:146]]
  09:40:23.985 [DLM-/patrick-test1-OrderedScheduler-4-0] INFO  o.a.d.ReadAheadEntryReader - Reinitialize log segments with [[LogSegmentId:115, firstTxId:0, lastTxId:10, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636291922, recordCount:11, regionId:0, status:0, logSegmentSequenceNumber:1, lastEntryId:20, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=1, entryId=0, slotId=0}, startSequenceId:0], [LogSegmentId:116, firstTxId:10, lastTxId:22, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636352198, recordCount:12, regionId:0, status:0, logSegmentSequenceNumber:2, lastEntryId:23, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=2, entryId=0, slotId=0}, startSequenceId:11], [LogSegmentId:117, firstTxId:22, lastTxId:34, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636412381, recordCount:12, regionId:0, status:0, logSegmentSequenceNumber:3, lastEntryId:23, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=3, entryId=0, slotId=0}, startSequenceId:23], [LogSegmentId:118, firstTxId:34, lastTxId:46, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636472579, recordCount:12, regionId:0, status:0, logSegmentSequenceNumber:4, lastEntryId:23, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=4, entryId=0, slotId=0}, startSequenceId:35], [LogSegmentId:119, firstTxId:46, lastTxId:58, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636532804, recordCount:12, regionId:0, status:0, logSegmentSequenceNumber:5, lastEntryId:23, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=5, entryId=0, slotId=0}, startSequenceId:47], [LogSegmentId:120, firstTxId:58, lastTxId:70, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636592955, recordCount:12, regionId:0, status:0, logSegmentSequenceNumber:6, lastEntryId:23, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=6, entryId=0, slotId=0}, startSequenceId:59], [LogSegmentId:121, firstTxId:70, lastTxId:82, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636653123, recordCount:12, regionId:0, status:0, logSegmentSequenceNumber:7, lastEntryId:23, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=7, entryId=0, slotId=0}, startSequenceId:71], [LogSegmentId:122, firstTxId:82, lastTxId:94, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636713228, recordCount:12, regionId:0, status:0, logSegmentSequenceNumber:8, lastEntryId:23, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=8, entryId=0, slotId=0}, startSequenceId:83], [LogSegmentId:123, firstTxId:94, lastTxId:100, version:VERSION_V5_SEQUENCE_ID, completionTime:1552636748278, recordCount:6, regionId:0, status:0, logSegmentSequenceNumber:9, lastEntryId:11, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=9, entryId=0, slotId=0}, startSequenceId:95], [LogSegmentId:125, firstTxId:100, lastTxId:107, version:VERSION_V5_SEQUENCE_ID, completionTime:1552637973443, recordCount:8, regionId:0, status:0, logSegmentSequenceNumber:10, lastEntryId:15, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=10, entryId=0, slotId=0}, startSequenceId:101], [LogSegmentId:127, firstTxId:107, lastTxId:109, version:VERSION_V5_SEQUENCE_ID, completionTime:1552638498401, recordCount:3, regionId:0, status:0, logSegmentSequenceNumber:11, lastEntryId:5, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=11, entryId=0, slotId=0}, startSequenceId:109], [LogSegmentId:129, firstTxId:109, lastTxId:121, version:VERSION_V5_SEQUENCE_ID, completionTime:1552638558701, recordCount:13, regionId:0, status:0, logSegmentSequenceNumber:12, lastEntryId:24, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=12, entryId=0, slotId=0}, startSequenceId:112], [LogSegmentId:130, firstTxId:121, lastTxId:126, version:VERSION_V5_SEQUENCE_ID, completionTime:1552638682182, recordCount:5, regionId:0, status:0, logSegmentSequenceNumber:13, lastEntryId:10, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=13, entryId=0, slotId=0}, startSequenceId:125], [LogSegmentId:132, firstTxId:126, lastTxId:126, version:VERSION_V5_SEQUENCE_ID, completionTime:1552638726059, recordCount:1, regionId:0, status:0, logSegmentSequenceNumber:14, lastEntryId:1, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=14, entryId=0, slotId=0}, startSequenceId:130], [LogSegmentId:134, firstTxId:126, lastTxId:127, version:VERSION_V5_SEQUENCE_ID, completionTime:1552639163714, recordCount:2, regionId:0, status:0, logSegmentSequenceNumber:15, lastEntryId:3, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=15, entryId=0, slotId=0}, startSequenceId:131], [LogSegmentId:136, firstTxId:127, lastTxId:139, version:VERSION_V5_SEQUENCE_ID, completionTime:1552639223980, recordCount:13, regionId:0, status:0, logSegmentSequenceNumber:16, lastEntryId:24, lastSlotId:0, inprogress:false, minActiveDLSN:DLSN{logSegmentSequenceNo=16, entryId=0, slotId=0}, startSequenceId:133], [LogSegmentId:137, firstTxId:139, lastTxId:-999, version:VERSION_V5_SEQUENCE_ID, completionTime:0, recordCount:0, regionId:0, status:0, logSegmentSequenceNumber:17, lastEntryId:-1, lastSlotId:-1, inprogress:true, minActiveDLSN:DLSN{logSegmentSequenceNo=17, entryId=0, slotId=0}, startSequenceId:146]]
  09:40:23.995 [DLM-/patrick-test1-OrderedScheduler-4-0] WARN  o.a.distributedlog.BKAsyncLogReader - log-2019-3-15:<default>: Exception
  org.apache.distributedlog.exceptions.ReadCancelledException: Read cancelled on stream inprogress_000000000000000017 : Reader was closed
  	at org.apache.distributedlog.impl.logsegment.BKLogSegmentEntryReader.asyncClose(BKLogSegmentEntryReader.java:869)
  	at org.apache.distributedlog.ReadAheadEntryReader$SegmentReader.lambda$close$1(ReadAheadEntryReader.java:182)
  	at java.util.concurrent.CompletableFuture.uniComposeStage(CompletableFuture.java:981)
  	at java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:2124)
  	at org.apache.distributedlog.ReadAheadEntryReader$SegmentReader.close(ReadAheadEntryReader.java:182)
  	at org.apache.distributedlog.ReadAheadEntryReader.unsafeMoveToNextLogSegment(ReadAheadEntryReader.java:912)
  	at org.apache.distributedlog.ReadAheadEntryReader.access$900(ReadAheadEntryReader.java:62)
  	at org.apache.distributedlog.ReadAheadEntryReader$4.safeRun(ReadAheadEntryReader.java:903)
  	at org.apache.distributedlog.ReadAheadEntryReader$CloseableRunnable.run(ReadAheadEntryReader.java:216)
  	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
  	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
  	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)
  	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)
  	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
  	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
  	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
  	at java.lang.Thread.run(Thread.java:748)
  09:40:23.995 [dlog-reader-0] ERROR b.p.distributedlog.DLogManager - error reading next entry
  java.util.concurrent.ExecutionException: org.apache.distributedlog.exceptions.ReadCancelledException: Read cancelled on stream inprogress_000000000000000017 : Reader was closed
  	at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:357)
  	at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1895)
  	at be.patrickhancke.distributedlog.DLogManager.lambda$tailLog$0(DLogManager.java:116)
  	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
  	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
  	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
  	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
  	at java.lang.Thread.run(Thread.java:748)
  Caused by: org.apache.distributedlog.exceptions.ReadCancelledException: Read cancelled on stream inprogress_000000000000000017 : Reader was closed
  	at org.apache.distributedlog.impl.logsegment.BKLogSegmentEntryReader.asyncClose(BKLogSegmentEntryReader.java:869)
  	at org.apache.distributedlog.ReadAheadEntryReader$SegmentReader.lambda$close$1(ReadAheadEntryReader.java:182)
  	at java.util.concurrent.CompletableFuture.uniComposeStage(CompletableFuture.java:981)
  	at java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:2124)
  	at org.apache.distributedlog.ReadAheadEntryReader$SegmentReader.close(ReadAheadEntryReader.java:182)
  	at org.apache.distributedlog.ReadAheadEntryReader.unsafeMoveToNextLogSegment(ReadAheadEntryReader.java:912)
  	at org.apache.distributedlog.ReadAheadEntryReader.access$900(ReadAheadEntryReader.java:62)
  	at org.apache.distributedlog.ReadAheadEntryReader$4.safeRun(ReadAheadEntryReader.java:903)
  	at org.apache.distributedlog.ReadAheadEntryReader$CloseableRunnable.run(ReadAheadEntryReader.java:216)
  	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
  	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
  	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)
  	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)
  	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
  	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
  	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
  	... 1 common frames omitted
